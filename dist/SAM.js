(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):(a=a||self,a.tp=b())})(this,function(){'use strict';var b=Math.floor,c=Number.isNaN;function a(a={}){function b(){return function(a,b){if(a){const c=async function(){const c=(await a.apply(this,arguments))||{};return c.__actionName=b,c};return c.__actionName=b,c}throw new Error(`addAction invalid action: ${b}`)}}const{max:c}=d(a.timetravel),{hasAsyncActions:j=!0,instanceName:k="global",synchronize:m=!1,clone:o=!1,requestStateRepresentation:e}=a,{synchronizeInterval:p=5}=d(m);let r;const s=new w(k),u=(a=[],b=[],c=s)=>b.map(b=>a.push(b(c)));let x;const B=[({__error:a})=>{a&&(0>a.stack.indexOf("AssertionError")?s.__error=a:(console.log("--------------------------------------"),console.log(a)))}],C=[()=>{s.hasNext(!!r&&r.hasNext())}],D=[];let E=a=>a.flush(),F=a=>a.flush(),G=F;const H=()=>{try{C.forEach(z),D.map(z).reduce(l,!1)||E(o?s.clone():s),s.renderNextTime()}catch(a){if(0>a.stack.indexOf("AssertionError"))setTimeout(()=>L({__error:a}),0);else throw a}},I=a=>{if(i(a.__name)){const b=a.__name;delete a.__name;const c=s.__formatBehavior?s.__formatBehavior(b,a,s):`${b}(${y(a)}) ==> ${y(s)}`;s.__behavior.push(c)}},J=a=>{if(a.__startTime){if(a.__startTime<=s.__lastProposalTimestamp)return!1;a.__startTime=s.__lastProposalTimestamp}return!0},K={_queue:[],_rendering:!1,add(a){this._queue.push(a)},synchronize(a){const b=this;return this._interval=setInterval(async()=>{if(!b._rendering&&0<b._queue.length){b._rendering=!0;const[c]=b._queue.slice(0,1);b._queue.shift(),c.__rendering=b._rendering,await a(...c),b._rendering=!1}},p),(...a)=>K.add(a)},clear(){clearInterval(this._interval)}};let L=m?async(a,b)=>{J(a)&&(s.resetEventQueue(),await Promise.all(B.map((await A(a)))),I(a),H(),b&&b())}:(a,b)=>{J(a)&&(B.forEach(A(a)),I(a),H(),b&&b())};m&&(L=K.synchronize(L));const M=(a={})=>{s.update(a),r&&r.snap(s,0),s.resetBehavior()},N=(a=[])=>a.map(a=>b=>()=>{const c=a.expression(b);return!!c&&(b.log({error:{name:a.name,model:b}}),r&&(b.update(r.last()),E(b)),!0)}),O=b=>!s.__blockUnexpectedActions&&0===s.allowedActions().length||s.allowedActions().map(c=>"string"==typeof c?c===b.__actionName:c===b).reduce(l,!1),P=a=>{i(a.name)&&s.setComponentState(a)},Q=(a={})=>{const{ignoreOutdatedProposals:e=!1,debounce:i=0,retry:c}=a.options||{};c&&(c.max=h(c.max),c.delay=g(c.delay));const k=i;P(a),x=j?f(a.actions).map(a=>{let f=!1,g=0;if("object"==typeof a){const c=a.label||a[0];a=b()(a.action||a[1],c)}const h=async(...b)=>{const i=new Date().getTime();if(O(a)){if(0<k&&f)return void(f=!d(b[0]).__resetDebounce);let j={};try{j=await a(...b)}catch(a){if(c)return g+=1,void(g<c.max&&setTimeout(()=>h(...b),c.delay));if(0>a.stack.indexOf("AssertionError"))j.__error=a;else throw a}e&&(j.__startTime=i);try{O(a)&&(L(j),g=0)}catch(a){if(0>a.stack.indexOf("AssertionError"))L({__error:a});else throw a}0<k&&(f=!0,setTimeout(()=>h({__resetDebounce:!0}),k))}};return h.__actionName=a.__actionName,h}):f(a.actions).map(a=>(...b)=>{try{if(O(a)){const c=a(...b);L(c)}else L({__error:`unexpected action ${a.__actionName||""}`})}catch(a){if(0>a.stack.indexOf("AssertionError"))L({__error:a});else throw a}}),u(B,a.acceptors,a.localState),u(C,a.reactors,a.localState),u(D,N(a.safety),a.localState),u(D,a.naps,a.localState)},R=a=>{const b=b=>{b.flush&&b.flush(),a&&a(b)};E=r?n(b,a=>r?r.snap(a):a):b,F=a},S=a=>{s.setLogger(a)},T=a=>{r=new t(a,{max:c}),s.hasNext(r.hasNext()),s.resetBehavior(),E=n(F,a=>r?r.snap(a):a)},U=(a={})=>{let b={};i(r)&&(a.reset&&(a.index=0,s.__behavior=[]),b=a.next?r.next():a.endOfTime?r.last():r.travel(a.index)),E(Object.assign(s,b))},V=({begin:b={},end:a})=>{const{render:c}=b;i(c)&&(G=E,E=c),i(a)&&(E=G)},W=({actions:a=[],clear:b=!1})=>(b&&s.clearAllowedActions(),0<a.length&&s.addAllowedActions(a),s.__allowedActions),X=([a,b])=>v.on(a,b);return({initialState:a,component:b,render:c,history:d,travel:e,logger:f,check:g,allowed:h,clearInterval:i,event:j})=>(x=[],q(d,T).on(a,M).on(b,Q).on(c,R).on(e,U).on(f,S).on(g,V).on(h,W).on(i,()=>K.clear()).on(j,X),{hasNext:s.hasNext(),hasError:s.hasError(),errorMessage:s.errorMessage(),error:s.error(),intents:x,state:a=>s.state(a,o)})}const d=(a,b={})=>a&&"object"==typeof a?a:b,f=(a,b=[])=>a&&Array.isArray(a)?a:b,g=(a,b=0)=>c(a)?b:a,h=(a,b=1)=>0===a||c(a)?0===b?1:b:a,j=(a,b=()=>null)=>a||b,k=(a=[])=>a[0],l=(a,b)=>a||b,m=(a,b)=>a&&b,n=(a,b)=>c=>a(b(c)),o=a=>Array.isArray(a)?a.map(o).reduce(m,!0):!0===a||null!==a&&a!==void 0,e=(a,b)=>{switch(typeof a){case"string":return"string"==typeof b&&a.includes(b);case"object":return Array.isArray(a)?a.includes(b):"string"==typeof b&&o(a[b]);}return a===b},i=(a,b)=>o(a)&&o(b)?e(a,b):o(a),p=(a,b,c=!0)=>(o(a)&&c&&b(a),r(o(a))),q=(a,b,c=!0)=>(o(a)&&c&&b(a),{on:q}),r=(a=!0)=>({oneOf:a?()=>r():p}),s=a=>{const b=a.__components;delete a.__components;const d=JSON.parse(JSON.stringify(a));return b&&(d.__components=[],0<b.length&&b.forEach(a=>{delete a.parent,d.__components.push(Object.assign(s(a),{parent:d}))})),d};class t{constructor(a=[],b={}){this.currentIndex=0,this.history=a,this.max=b.max}snap(a,b){const c=s(a);return b?this.history[b]=c:(this.history.push(c),this.max&&this.history.length>this.max&&this.history.shift()),a}travel(a=0){return this.currentIndex=a,this.history[a]}next(){return this.history[this.currentIndex++]}hasNext(){return i(this.history[this.currentIndex])}last(){return this.currentIndex=this.history.length-1,this.history[this.currentIndex]}}const u={};var v={on:(a,b)=>{i(u[a])||(u[a]=[]),u[a].push(b)},off:(a,b)=>{f(u[a]).forEach((c,d)=>{c===b&&u[a].splice(d,1)})},emit:(a=[],b)=>{Array.isArray(a)?a.forEach(a=>f(u[a]).forEach(a=>a(b))):f(u[a]).forEach(a=>a(b))}};class w{constructor(a){this.__components={},this.__behavior=[],this.__name=a,this.__lastProposalTimestamp=0,this.__allowedActions=[],this.__eventQueue=[]}localState(a){return i(a)?this.__components[a]:{}}hasError(){return i(this.__error)}error(){return this.__error||void 0}errorMessage(){return d(this.__error).message}clearError(){return delete this.__error}allowedActions(){return this.__allowedActions}clearAllowedActions(){this.__allowedActions=[]}addAllowedActions(b){this.__allowedActions.push(b)}resetBehavior(){this.__behavior=[]}update(a={}){Object.assign(this,a)}setComponentState(a){this.__components[a.name]=Object.assign(d(a.localState),{parent:this}),a.localState=a.localState||this.__components[a.name]}hasNext(a){return i(a)&&(this.__hasNext=a),this.__hasNext}continue(){return!0===this.__continue}renderNextTime(){delete this.__continue}doNotRender(){this.__continue=!0}setLogger(a){this.__logger=a}log({trace:a,info:b,warning:c,error:d,fatal:e}){this.logger&&p(a,this.logger.trace(a)).oneOf(b,this.logger.info(b)).oneOf(c,this.logger.waring(c)).oneOf(d,this.logger.error(c)).oneOf(e,this.logger.fatal(c))}prepareEvent(a,b){this.__eventQueue.push([a,b])}resetEventQueue(){this.__eventQueue=[]}flush(){!1===this.continue()&&(f(this.__eventQueue).forEach(([a,b])=>v.emit(a,b)),this.__eventQueue=[])}clone(a=this){const b=a.__components;delete a.__components;const d=JSON.parse(JSON.stringify(a));return b&&(d.__components={},Object.keys(b).forEach(a=>{const e=b[a];delete e.parent,d.__components[a]=Object.assign(this.clone(e),{parent:d})})),d}state(a,b){const c=a=>i(this[a])?this[a]:i(this.__components[a])?this.__components[a]:this;let d;return d=Array.isArray(a)?a.map(a=>c(a)):c(a),b&&d?this.clone(d):d}}const x=(a,b)=>b?JSON.stringify(a,null,4):JSON.stringify(a),y=(a={},b=!1)=>{const c=Object.keys(a);return`${c.map(c=>"string"==typeof c?0===c.indexOf("__")?"":x(a[c],b):"").filter(a=>""!==a).join(", ")}`},z=a=>a(),A=b=>async c=>c(b),B=a();var C=(a=B)=>({addInitialState:b=>a({initialState:b}),addComponent:b=>a({component:b}),setRender:b=>{if(Array.isArray(b)){const[a,c]=b;b=b=>a("function"==typeof c?c(b):b)}a({render:j(b)})},addHandler:(b,c)=>a({event:[b,c]}),getIntents:b=>a({component:{actions:b}}),addAcceptors:(b,c)=>a({component:{acceptors:b,privateModel:c}}),addReactors:(b,c)=>a({component:{reactors:b,privateModel:c}}),addNAPs:(b,c)=>a({component:{naps:b,privateModel:c}}),addSafetyConditions:(b,c)=>a({component:{safety:b,privateModel:c}}),hasError:()=>a({}).hasError,allow:b=>a({allowed:{actions:b}}),clearAllowedActions:()=>a({allowed:{clear:!0}}),allowedActions:()=>a({allowed:{}}),addTimeTraveler:(b=[])=>a({history:b}),travel:(b=0)=>a({travel:{index:b}}),next:()=>a({travel:{next:!0}}),last:()=>a({travel:{endOfTime:!0}}),hasNext:()=>a({}).hasNext,reset:b=>b?a({initialState:b}):a({travel:{reset:!0}}),beginCheck:b=>a({check:{begin:{render:b}}}),endCheck:()=>a({check:{end:!0}})});const D=(a,b,c,d,e,f)=>{const g=[];return 0===b.length?a.forEach(a=>{if(0<f.length){const b=f.map(b=>a.name!==b).reduce(m,!0);b&&g.push([a])}else g.push([a])}):b.forEach(b=>a.forEach(a=>{const c=b.concat([a]);e?b[b.length-1]!==a&&g.push(c):g.push(c)})),c++,c<d?D(a,g,c,d,e,f):g.filter(a=>a.length===d)},E=a=>{const c=a.map(a=>f(d(a).values).length),e=c.map((a,b)=>{let d=1;for(let e=b;e<c.length;e++)d*=c[e];return d}),g=c.reduce((a,b)=>a*b,1);if(0===g)throw new Error("Checker: invalid dataset, one of the intents values has no value.\nIf an intent has no parameter, add an empty array to its values");return{increment:a=>e.map((d,f)=>f===e.length-1?a%c[f]:b(a/e[f+1])%c[f]),kmax:g}},F=(a=[],b,c)=>{a.forEach(a=>{let d=0;const{increment:e,kmax:f}=E(a);do{const f=e(d++),g=a.map((a,b)=>a.values[f[b]]);b(),c([]),a.forEach((a,b)=>a.intent(...g[b]))}while(d<f)})},{addInitialState:G,addComponent:H,setRender:I,addSafetyConditions:J,getIntents:K,addAcceptors:L,addReactors:M,addNAPs:N}=C();var O={SAM:B,createInstance:a,api:C,addInitialState:G,addComponent:H,addAcceptors:L,addReactors:M,addNAPs:N,addSafetyConditions:J,getIntents:K,setRender:I,step:()=>({}),doNotRender:a=>()=>!0===a.continue(),first:k,match:(a,b)=>k(a.map((a,c)=>a?b[c]:null).filter(o)),on:q,oneOf:p,utils:{O:d,A:f,N:g,NZ:h,S:(a,b="")=>a&&"string"==typeof a?a:b,F:j,E:i,or:l,and:m,log:a=>(...b)=>{console.log(b),a(...b)}},events:{on:v.on,off:v.off,emit:v.emit},checker:({instance:a,initialState:f={},intents:g=[],reset:b,liveness:c,safety:d,options:e},h=()=>null,j=()=>null)=>{const{beginCheck:k,endCheck:l}=C(a),{depthMax:n=5,noDuplicateAction:o=!1,doNotStartWith:p=[],format:m}=e,[q,r]=a({component:{actions:[a=>({__behavior:a}),a=>({__setFormatBehavior:a})],acceptors:[a=>({__behavior:b})=>{i(b)&&(a.__behavior=b)},a=>({__setFormatBehavior:b})=>{i(b)&&(a.__formatBehavior=b)}]}}).intents;r(m);const s=[];return k(a=>{c&&c(a)&&(s.push({liveness:a.__behavior}),h(a.__behavior)),d&&d(a)&&(s.push({safety:a.__behavior}),j(a.__behavior))}),F(D(g,[],0,n,o,p),()=>b(f),q),l(),s}};return O});